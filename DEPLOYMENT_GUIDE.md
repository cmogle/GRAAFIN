# GRAAFIN.club Deployment Guide

This guide walks you through deploying the GRAAFIN frontend to Cloudflare Pages and the backend to Render.com.

## Architecture Overview

```
┌─────────────────┐         ┌──────────────────┐
│  GRAAFIN.club   │  ─────> │  Backend API     │
│  (Cloudflare    │  HTTPS  │  (Render.com)    │
│   Pages)        │         │                  │
│  Static HTML/JS │         │  Express Server  │
└─────────────────┘         └──────────────────┘
```

## Prerequisites

- GitHub repository with your code
- Cloudflare account (free)
- Render.com account (free tier available)
- Domain: GRAAFIN.club (already purchased)

## Part 1: Deploy Backend to Render.com

### Step 1: Push Code to GitHub

1. Ensure your code is pushed to a GitHub repository
2. Make sure `render.yaml` is in the root directory

### Step 2: Create Render.com Service

1. Go to [Render Dashboard](https://dashboard.render.com)
2. Click **New** > **Blueprint**
3. Connect your GitHub repository
4. Render will automatically detect `render.yaml` and create:
   - **Web Service** (`graafin-web`) - Your backend API
   - **Cron Job** (`graafin-cron`) - Monitoring service

### Step 3: Configure Environment Variables

In the Render dashboard, go to your web service and add these environment variables:

**Required:**
- `TWILIO_ACCOUNT_SID` - Your Twilio Account SID
- `TWILIO_AUTH_TOKEN` - Your Twilio Auth Token
- `TWILIO_WHATSAPP_FROM` - Twilio WhatsApp number (format: `whatsapp:+14155238886`)
- `NOTIFY_WHATSAPP` - Your phone number for notifications
- `ADMIN_API_KEY` - Secret key for admin endpoints (generate a secure random string)
- `CORS_ORIGIN` - Set to: `https://graafin.club,https://www.graafin.club`

**Optional:**
- `TARGET_URL` - URL to monitor (defaults to hopasports event)
- `MONITOR_SECRET` - Auto-generated by Render (used by cron job)
- `ENABLE_STATIC_FILES` - Set to `false` to disable static file serving (API-only mode). Recommended when frontend is deployed separately to Cloudflare Pages. Default: `true` (enabled for backward compatibility)

### Step 4: Get Backend URL

After deployment, note your backend URL:
- Format: `https://graafin-web.onrender.com`
- Or if you add a custom domain: `https://api.graafin.club`

**Important:** The backend will sleep after 15 minutes of inactivity on the free tier. First request after sleep takes ~30 seconds.

## Part 2: Deploy Frontend to Cloudflare Pages

### Step 1: Prepare Frontend Directory

The frontend is in the `frontend/` directory. Ensure it contains:
- `index.html`
- `config.js`
- `_redirects`
- `README.md`

### Step 2: Create Cloudflare Pages Project

1. Go to [Cloudflare Dashboard](https://dash.cloudflare.com)
2. Navigate to **Pages** > **Create a project**
3. Click **Connect to Git**
4. Select your GitHub repository

### Step 3: Configure Build Settings

**Project name:** `graafin-frontend` (or any name)

**Build settings:**
- **Framework preset:** None (or "Plain HTML")
- **Build command:** (leave empty - no build needed)
- **Build output directory:** `frontend`
- **Root directory:** `/` (root of repository)

### Step 4: Configure API URL

You have two options:

**Option A: Manual Update (Simplest)**
1. Edit `frontend/config.js`
2. Update the default API URL:
   ```javascript
   window.API_BASE = window.API_BASE || 'https://graafin-web.onrender.com/api';
   ```
3. Commit and push - Cloudflare Pages will auto-deploy

**Option B: Automated Build Script**
1. In Cloudflare Pages build settings:
   - **Build command:** `cd frontend && node build-config.js`
   - **Build output directory:** `frontend`
2. Add environment variable:
   - **Variable name:** `API_URL`
   - **Value:** Your backend API URL (e.g., `https://graafin-web.onrender.com/api`)
   - **Environment:** Production (and Preview if desired)

### Step 5: Configure Custom Domain

1. In Cloudflare Pages project, go to **Custom domains**
2. Click **Set up a custom domain**
3. Enter `graafin.club`
4. Cloudflare will provide DNS instructions

### Step 6: Update DNS Records

At your domain registrar (where you purchased GRAAFIN.club):

**Option A: Use Cloudflare Nameservers (Recommended)**
1. Change nameservers to Cloudflare's (provided in Cloudflare dashboard)
2. Cloudflare will automatically configure DNS

**Option B: Keep Current Nameservers**
1. Add a CNAME record:
   - **Name:** `@` (or root domain)
   - **Value:** Cloudflare Pages URL (provided in dashboard)
2. Add another CNAME for www:
   - **Name:** `www`
   - **Value:** Same Cloudflare Pages URL

**SSL:** Cloudflare automatically provides SSL certificates (HTTPS)

## Part 3: Update Frontend Configuration

Since Cloudflare Pages doesn't automatically inject environment variables into static files, you have two options:

### Option 1: Manual Update (Simplest)

1. Edit `frontend/config.js`
2. Update the default API URL:
   ```javascript
   window.API_BASE = 'https://graafin-web.onrender.com/api';
   ```
3. Commit and push - Cloudflare Pages will auto-deploy

### Option 2: Build Script (Advanced)

Create a simple build script that replaces the placeholder:

1. Create `frontend/build.js`:
   ```javascript
   const fs = require('fs');
   const config = fs.readFileSync('config.js', 'utf8');
   const apiUrl = process.env.API_URL || 'https://graafin-web.onrender.com/api';
   const updated = config.replace('%API_URL%', apiUrl);
   fs.writeFileSync('config.js', updated);
   ```

2. Update Cloudflare Pages build settings:
   - **Build command:** `cd frontend && node build.js`
   - **Build output directory:** `frontend`

## Part 4: Testing

### Test Backend

1. Visit your Render.com backend URL: `https://graafin-web.onrender.com/api/health`
2. Should return: `{"status":"ok",...}`

### Test Frontend

1. Visit `https://graafin.club`
2. Open browser console (F12)
3. Check that `window.API_BASE` is set correctly
4. Try searching for an athlete
5. Verify API calls are going to the correct backend URL

### Test CORS

1. Open browser console on `https://graafin.club`
2. Run: `fetch('https://graafin-web.onrender.com/api/health').then(r => r.json()).then(console.log)`
3. Should succeed without CORS errors

## Troubleshooting

### Frontend can't connect to backend

- Check `window.API_BASE` in browser console
- Verify backend URL is correct in `config.js`
- Check backend is running (not sleeping) on Render.com
- Verify CORS is configured correctly in `src/server.ts`

### CORS errors

- Ensure `CORS_ORIGIN` environment variable in Render includes `https://graafin.club`
- Check browser console for exact error message
- Verify backend allows credentials if needed

### Backend sleeping (free tier)

- First request after sleep takes ~30 seconds
- Consider upgrading to Render paid plan ($7/month) to keep service awake
- Or use a ping service to keep it awake (not recommended for production)

### DNS not resolving

- Wait 24-48 hours for DNS propagation
- Check DNS records at your registrar
- Verify Cloudflare Pages custom domain is configured
- Use `dig graafin.club` or `nslookup graafin.club` to check DNS

## Cost Summary

- **Cloudflare Pages:** Free (unlimited bandwidth, 500 builds/month)
- **Render.com Free Tier:** Free (750 hours/month, sleeps after 15min)
- **Render.com Paid:** $7/month (always-on service)
- **Total:** $0/month (free tier) or $7/month (always-on backend)

## Next Steps

1. Set up monitoring/alerting for backend uptime
2. Configure custom domain for backend (`api.graafin.club`)
3. Set up CI/CD for automatic deployments
4. Add analytics to frontend
5. Consider upgrading Render.com if backend needs to stay awake

## Support

- [Cloudflare Pages Docs](https://developers.cloudflare.com/pages/)
- [Render.com Docs](https://render.com/docs)
- [CORS Configuration](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS)
